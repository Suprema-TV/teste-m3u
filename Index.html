<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Teste Simplificado Canais AMC</title>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <style>
    body {
      background: #111;
      color: #fff;
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 20px;
    }
    video {
      width: 90%;
      max-width: 800px;
      margin: 20px auto;
      display: block;
      border-radius: 8px;
      background: black;
    }
    button {
      background: #ff4747;
      border: none;
      padding: 10px 20px;
      margin: 6px;
      color: white;
      cursor: pointer;
      border-radius: 6px;
    }
    button:hover {
      background: #e63e3e;
    }
  </style>
</head>
<body>

  <h1>Teste Canais AMC - Simplificado</h1>
  <div id="botoes"></div>
  <video id="videoPlayer" controls autoplay muted></video>

  <script>
    const video = document.getElementById('videoPlayer');
    const botoesDiv = document.getElementById('botoes');

    async function tocar(urlOriginal) {
      // urlOriginal já vem com proxy, então vamos carregar direto
      if (!urlOriginal) {
        alert('URL inválida');
        return;
      }

      if (!Hls.isSupported() && !video.canPlayType('application/vnd.apple.mpegurl')) {
        alert('Seu navegador não suporta HLS.');
        return;
      }

      // Se hls.js suportado, usa ele, senão tenta player nativo Safari
      if (Hls.isSupported()) {
        window.hls?.destroy();

        const hls = new Hls();

        // Faz com que os fragmentos TS também passem pelo proxy
        hls.on(Hls.Events.FRAG_LOADING, (event, data) => {
          const original = data.frag.url;
          data.frag.url = "https://ts-producao.netlify.app/.netlify/functions/proxy?url=" + encodeURIComponent(original);
        });

        hls.loadSource(urlOriginal);
        hls.attachMedia(video);
        hls.on(Hls.Events.MANIFEST_PARSED, () => video.play());

        window.hls = hls;
      } else {
        // Safari / iOS fallback
        video.src = urlOriginal;
        video.play();
      }
    }

    // Pega a lista M3U do GitHub e cria botões com proxy no Netlify Functions
    fetch('https://raw.githubusercontent.com/Suprema-TV/teste-m3u/main/lista-teste.m3u')
      .then(res => res.text())
      .then(texto => {
        const linhas = texto.split('\n');
        for (let i = 0; i < linhas.length; i++) {
          if (linhas[i].startsWith('#EXTINF')) {
            const nome = linhas[i].split(',')[1]?.trim() || 'Sem nome';
            const url = linhas[i + 1]?.trim();
            if (url && url.startsWith('http')) {
              const btn = document.createElement('button');
              btn.textContent = nome;
              // Passa a url do canal pelo proxy Netlify Functions para evitar CORS
              const urlComProxy = "https://ts-producao.netlify.app/.netlify/functions/proxy?url=" + encodeURIComponent(url);
              btn.onclick = () => tocar(urlComProxy);
              botoesDiv.appendChild(btn);
            }
          }
        }
      });
  </script>

</body>
</html>
