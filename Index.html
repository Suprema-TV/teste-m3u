<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Teste Simplificado Canais AMC</title>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <style>
    body {
      background: #111;
      color: #fff;
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 20px;
    }
    video {
      width: 90%;
      max-width: 800px;
      margin: 20px auto;
      display: block;
      border-radius: 8px;
      background: black;
    }
    button {
      background: #ff4747;
      border: none;
      padding: 10px 20px;
      margin: 6px;
      color: white;
      cursor: pointer;
      border-radius: 6px;
    }
    button:hover {
      background: #e63e3e;
    }
  </style>
</head>
<body>

  <h1>Teste Canais AMC - Simplificado</h1>
  <div id="botoes"></div>
  <video id="videoPlayer" controls autoplay muted></video>

  <script>
    const video = document.getElementById('videoPlayer');
    const botoesDiv = document.getElementById('botoes');
    let hls = null;

    function tocar(urlOriginal) {
      // Proxy da Netlify para contornar CORS e mixed content
      const urlProxy = `/.netlify/functions/proxy?url=${encodeURIComponent(urlOriginal)}`;

      if (Hls.isSupported()) {
        if (hls) {
          hls.destroy();
          hls = null;
        }

        hls = new Hls();

        // Intercepta fragmentos .ts para passar pelo proxy também
        hls.on(Hls.Events.FRAG_LOADING, function(event, data) {
          const original = data.frag.url;
          if (!original.startsWith('/.netlify/functions/proxy')) {
            data.frag.url = `/.netlify/functions/proxy?url=${encodeURIComponent(original)}`;
          }
        });

        hls.loadSource(urlProxy);
        hls.attachMedia(video);
        hls.on(Hls.Events.MANIFEST_PARSED, () => video.play());
      } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
        // Fallback Safari/iOS
        video.src = urlProxy;
        video.play();
      } else {
        alert('Seu navegador não suporta HLS.');
      }
    }

    // Carrega lista M3U pública do GitHub (substitua pela sua)
    fetch('https://raw.githubusercontent.com/Suprema-TV/teste-m3u/main/lista-teste.m3u')
      .then(res => res.text())
      .then(texto => {
        const linhas = texto.split('\n');
        for (let i = 0; i < linhas.length; i++) {
          if (linhas[i].startsWith('#EXTINF')) {
            const nome = linhas[i].split(',')[1]?.trim() || 'Sem nome';
            const url = linhas[i + 1]?.trim();
            if (url && url.startsWith('http')) {
              const btn = document.createElement('button');
              btn.textContent = nome;
              btn.onclick = () => tocar(url);
              botoesDiv.appendChild(btn);
            }
          }
        }
      });
  </script>

</body>
</html>
