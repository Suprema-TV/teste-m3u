<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Painel Admin - Tokens Ativos</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #111;
      color: #f0f0f0;
      padding: 20px;
      max-width: 900px;
      margin: auto;
    }
    h2 {
      color: #0af;
    }
    ul {
      list-style: none;
      padding: 0;
    }
    li {
      background: #222;
      border-left: 5px solid #0af;
      margin-bottom: 15px;
      padding: 12px 15px;
      border-radius: 6px;
    }
    button {
      margin-right: 10px;
      margin-top: 8px;
      padding: 6px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      background-color: #444;
      color: #fff;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: #0af;
    }
    .alerta {
      color: #f33;
      font-weight: bold;
      margin-top: 6px;
    }
    a {
      color: #0af;
      word-break: break-all;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    small {
      display: block;
      margin-top: 4px;
      color: #ccc;
    }
  </style>
</head>
<body>
  <h2>üìã Tokens Ativos</h2>
  <ul id="listaTokens"></ul>

  <script>
    const firebaseUrl = "https://cadastro-c2424-default-rtdb.firebaseio.com/token";

    async function carregarTokens() {
      try {
        const res = await fetch(firebaseUrl + ".json");
        const dados = await res.json();
        if (!dados) {
          document.getElementById("listaTokens").innerHTML = "<li>Nenhum token encontrado.</li>";
          return;
        }

        const lista = document.getElementById("listaTokens");
        lista.innerHTML = "";

        const tokensArray = Object.entries(dados);
        const deviceCount = {};

        // Contar quantos tokens usam o mesmo deviceId
        tokensArray.forEach(([_, valor]) => {
          const id = valor.deviceId || "desconhecido";
          deviceCount[id] = (deviceCount[id] || 0) + 1;
        });

        tokensArray.forEach(([chave, valor]) => {
          const li = document.createElement("li");
          const { email, link, deviceId, userAgent } = valor;

          const alerta = deviceId && deviceCount[deviceId] > 1
            ? `<div class="alerta">‚ö† M√∫ltiplos tokens com este dispositivo</div>` : "";

          li.innerHTML = `
            <strong>Usu√°rio:</strong> ${email || "N√£o informado"}<br>
            <strong>Link:</strong> <a href="${link}" target="_blank" rel="noopener noreferrer">${link}</a><br>
            <strong>Device ID:</strong> ${deviceId || "N√£o registrado"}<br>
            <strong>User-Agent:</strong><small>${userAgent || "Indefinido"}</small>
            ${alerta}
            <br>
            <button onclick="copiar('${link}')">üîó Copiar Link</button>
            <button onclick="remover('${chave}')">‚ùå Remover</button>
          `;
          lista.appendChild(li);
        });
      } catch (e) {
        console.error("Erro ao carregar tokens:", e);
        document.getElementById("listaTokens").innerHTML = "<li>Erro ao carregar dados.</li>";
      }
    }

    function copiar(texto) {
      navigator.clipboard.writeText(texto)
        .then(() => alert("üîó Link copiado!"))
        .catch(err => alert("Erro ao copiar: " + err));
    }

    async function remover(chave) {
      if (confirm("Deseja remover este token?")) {
        try {
          await fetch(`${firebaseUrl}/${chave}.json`, { method: "DELETE" });
          carregarTokens();
        } catch (err) {
          alert("Erro ao remover token: " + err);
        }
      }
    }

    carregarTokens();
    setInterval(carregarTokens, 10000); // Atualiza a cada 10s
  </script>
</body>
</html>
